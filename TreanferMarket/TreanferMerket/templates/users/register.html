{% extends 'base.html' %}
{% load static %}

{% block title_name %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è{% endblock %}

{% block header %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/register.css' %}">
{% endblock %}

{% block content %}
    <div class="form-container">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <form id="registerForm" method="post">
            {% csrf_token %}
            {% for field in form %}
                <div class="form-group">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {% if field.name == 'password1' or field.name == 'password2' %}
                        <div class="password-wrapper">
                            {{ field }}
                            <span class="toggle-password" onclick="togglePassword(this)">üôÇ</span>
                        </div>
                    {% else %}
                        {{ field }}
                    {% endif %}
                    {% if field.errors %}
                        <div class="error">{{ field.errors }}</div>
                    {% endif %}
                </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <a href="{% url 'info_view' %}" class="back-button">‚Üê –ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </form>
    </div>

    {% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');

            if (registerForm) {
                registerForm.addEventListener('submit', async function(event) {
                    event.preventDefault();

                    const username = document.getElementById('id_username').value;
                    const email = document.getElementById('id_email').value;
                    const password = document.getElementById('id_password1').value;
                    const password2 = document.getElementById('id_password2').value;
                    

                    console.log('–ó–Ω–∞—á–µ–Ω–∏–µ username:', username);
                    console.log('–ó–Ω–∞—á–µ–Ω–∏–µ email:', email);
                    console.log('–ó–Ω–∞—á–µ–Ω–∏–µ password1:', password);
                    console.log('–ó–Ω–∞—á–µ–Ω–∏–µ password2:', password2);

                    if (password !== password2) {
                        alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ.');
                        return; 
                    }

                    const data = {
                        username: username,
                        email: email,
                        password: password,
                        coins: 1000
                    };

                    console.log('–ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –≤ API:', JSON.stringify(data, null, 2));

                    try {
                        const response = await fetch('/api/users/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken'),
                            },
                            body: JSON.stringify(data),
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                            window.location.href = '/login/'; 
                        } else {
                            let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.';
                            if (result) {
                                errorMessage += '\n' + JSON.stringify(result, null, 2);
                            }
                            alert(errorMessage);
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö.');
                    }
                });
            }
        });

        function togglePassword(el) {
            const input = el.previousElementSibling;
            const type = input.getAttribute("type") === "password" ? "text" : "password";
            input.setAttribute("type", type);
            el.textContent = type === "password" ? "üôÇ" : "ü´£";
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∫—É–∫–∏
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
    {% endblock %}
{% endblock %} 